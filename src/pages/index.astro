---
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import FadeIn from '../components/FadeIn.astro'; 
import { getCollection, type CollectionEntry } from 'astro:content';
import Card from '../components/Card.astro';
import { Icon } from 'astro-icon/components';

const blogEntries = await getCollection('blog');
const projectEntries = await getCollection('projects');
const courseEntries = (await getCollection('courses')).filter(
  (course: CollectionEntry<'courses'>) => course.id.endsWith('index.mdx') || course.id.endsWith('index.md')
);

const allContent = [
  ...blogEntries.map((entry: CollectionEntry<'blog'>) => ({
    type: 'blog' as const,
    title: entry.data.title,
    description: entry.data.description,
    href: `/blog/${entry.slug}/`,
    tags: entry.data.tags,
    publishDate: entry.data.publishDate,
    heroImage: entry.data.heroImage,
    featured: entry.data.featured,
  })),
  ...projectEntries.map((entry: CollectionEntry<'projects'>) => ({
    type: 'project' as const,
    title: entry.data.title,
    description: entry.data.description,
    href: `/projects/${entry.slug}/`,
    tags: entry.data.tags,
    publishDate: entry.data.publishDate,
    heroImage: entry.data.heroImage,
    featured: entry.data.featured,
  })),
  ...courseEntries.map((entry: CollectionEntry<'courses'>) => ({
    type: 'course' as const,
    title: entry.data.title,
    description: entry.data.description,
    href: `/courses/${entry.slug.replace(/\/index$/, '')}/`,
    tags: entry.data.tags || [],
    publishDate: entry.data.publishDate,
    heroImage: entry.data.heroImage,
    featured: entry.data.featured,
  })),
];

const fallbackDate = new Date('1970-01-01');

const featuredContent = allContent
  .filter(item => item.featured === true)
  .sort((a, b) => (
    (b.publishDate ? new Date(b.publishDate) : fallbackDate).valueOf() -
    (a.publishDate ? new Date(a.publishDate) : fallbackDate).valueOf()
  ))
  .slice(0, 4);

const seo = {
  title: "Home",
  description: "Welcome to the professional portfolio of Faisal Durbaa. Discover projects, writings, and more."
};
---
<Layout seo={seo}>
  <FadeIn>
    <Hero />
  </FadeIn>

  <!-- Floating Scroll Indicator -->
  <div id="scroll-indicator" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-40 transition-all duration-500 ease-out cursor-pointer hover:scale-105 hidden md:flex flex-col items-center">
    <div class="w-12 h-12 flex items-center justify-center rounded-full bg-white shadow-lg shadow-accent/20 border border-accent/30 text-accent hover:text-accent/90 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
      </svg>
    </div>
  </div>

  <section id="featured-section" class="py-16">
    <div class="mx-auto w-full max-w-[1800px] px-[clamp(3.25rem,8vw,7.25rem)] space-y-10">
      <FadeIn>
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <h2 class="text-3xl font-bold text-gray-900">Featured</h2>
        </div>
      </FadeIn>

      <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6 lg:gap-8 items-stretch">
        {featuredContent.map(item => (
          <FadeIn>
            <Card
              title={item.title}
              description={item.description}
              href={item.href}
              tags={item.tags ?? []}
              type={item.type}
              publishDate={item.publishDate}
              heroImage={item.heroImage}
            />
          </FadeIn>
        ))}
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-6">
        <a href="/projects/" class="inline-flex items-center justify-center gap-3 rounded-xl bg-accent text-white px-5 py-4 text-base font-semibold shadow-lg shadow-accent/20 transition-transform duration-200 hover:-translate-y-[1px] hover:shadow-xl">
          <Icon name="mdi:rocket-launch" class="w-5 h-5" />
          <span>View Projects</span>
        </a>
        <a href="/blog/" class="inline-flex items-center justify-center gap-3 rounded-xl bg-accent text-white px-5 py-4 text-base font-semibold shadow-lg shadow-accent/20 transition-transform duration-200 hover:-translate-y-[1px] hover:shadow-xl">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h10" />
          </svg>
          <span>Read Blog Posts</span>
        </a>
        <a href="/contact/" class="inline-flex items-center justify-center gap-3 rounded-xl bg-accent text-white px-5 py-4 text-base font-semibold shadow-lg shadow-accent/20 transition-transform duration-200 hover:-translate-y-[1px] hover:shadow-xl">
          <Icon name="mdi:email-fast-outline" class="w-5 h-5" />
          <span>Get In Touch</span>
        </a>
      </div>
    </div>
  </section>
</Layout>

<script>
  function setupScrollIndicator() {
    const scrollIndicator = document.getElementById('scroll-indicator');
    const featuredSection = document.getElementById('featured-section');
    if (!scrollIndicator || !featuredSection || scrollIndicator.dataset.bound === 'true') return;

    scrollIndicator.dataset.bound = 'true';

    scrollIndicator.addEventListener('click', () => {
      const top = featuredSection.getBoundingClientRect().top + window.scrollY;
      window.scrollTo({ top: top - 40, behavior: 'smooth' });
    });

    const onScroll = () => {
      const scrollY = window.scrollY;
      if (scrollY > 100) {
        scrollIndicator.style.opacity = '0';
        scrollIndicator.style.pointerEvents = 'none';
        scrollIndicator.style.transform = 'translate(-50%, 20px)';
      } else {
        scrollIndicator.style.opacity = '1';
        scrollIndicator.style.pointerEvents = 'auto';
        scrollIndicator.style.transform = 'translate(-50%, 0)';
      }
    };

    window.addEventListener('scroll', onScroll, { passive: true });
    onScroll();
  }

  if (typeof window !== 'undefined') {
    setupScrollIndicator();
    document.addEventListener('astro:after-swap', () => {
      // allow rebind after swap
      const indicator = document.getElementById('scroll-indicator');
      if (indicator) indicator.dataset.bound = 'false';
      setupScrollIndicator();
    });
  }
</script>
