---
import Layout from '../layouts/Layout.astro';
import FadeIn from '../components/FadeIn.astro';
import { Icon } from 'astro-icon/components';

const seo = {
  title: "Contact",
  description: "Get in touch with Faisal Durbaa. Send a message via the contact form or connect on social media."
};
const formspreeFormId = import.meta.env.PUBLIC_FORMSPREE_ID ?? '';
const recaptchaSiteKey = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY ?? '';
---
<Layout seo={seo}>
  <div class="mx-auto w-full max-w-[1200px] px-[clamp(2.75rem,7vw,6.5rem)] py-16">
    <FadeIn>
      <div class="relative overflow-hidden rounded-3xl border border-white/60 bg-white/80 backdrop-blur-xl shadow-2xl">
        <div class="absolute inset-0 bg-gradient-to-br from-white via-[#eef3fb]/70 to-[#dfe9f5]/50 pointer-events-none"></div>
        <div class="relative grid grid-cols-1 lg:grid-cols-2 divide-y lg:divide-y-0 lg:divide-x divide-gray-200/70">
          <div class="p-8 md:p-10 space-y-6">
            <div class="space-y-3">
              <h1 class="text-4xl font-bold text-gray-900 leading-tight">Let&apos;s get in touch</h1>
              <p class="text-lg text-gray-700">
                Tell me what you&apos;re working on or what you need help with. I&apos;ll reply with next steps.
              </p>
            </div>
            <div class="rounded-2xl border border-accent/10 bg-accent/5 p-4 text-sm text-gray-800">
              <p class="font-semibold text-accent mb-2">Helpful details</p>
              <ul class="list-disc list-inside space-y-1 text-gray-700">
                <li>Context or topic</li>
                <li>What you&apos;re looking for (collaboration, feedback...)</li>
                <li>Links (repo/brief) optional</li>
              </ul>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <a href="https://github.com/faisaldurbaa" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center gap-2 rounded-xl bg-accent text-white px-5 py-3 font-semibold shadow-lg shadow-accent/25 hover:shadow-accent/35 transition-all duration-200 hover:-translate-y-[1px]">
                <Icon name="mdi:github" class="w-5 h-5" />
                GitHub
              </a>
              <a href="https://www.linkedin.com/in/faisaldurbaa/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center gap-2 rounded-xl border border-accent/30 bg-white/80 text-accent font-semibold px-5 py-3 shadow-sm hover:border-accent hover:bg-accent/10 hover:shadow-md transition-all duration-200">
                <Icon name="mdi:linkedin" class="w-5 h-5" />
                LinkedIn
              </a>
            </div>
            <p class="text-sm text-gray-600">Happy to chat about projects, ideas, or questions.</p>
          </div>

          <div class="p-8 md:p-10 space-y-4" id="contact-form-section">
            <div id="success-message" class="hidden bg-emerald-50 border border-emerald-200 text-emerald-800 px-4 py-3 rounded-xl" role="alert" aria-live="polite">
              <strong class="font-semibold">Thanks!</strong> Your message has been sent.
            </div>
            <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-xl" role="alert" aria-live="polite">
              <strong class="font-semibold">Oops.</strong> Something went wrong. Please try again.
            </div>

            <form id="contact-form" class="space-y-4" autocomplete="on">
              <div class="space-y-2">
                <label for="name" class="block text-gray-800 font-semibold">Name</label>
                <input type="text" id="name" name="name" required autocomplete="name" class="w-full rounded-xl border border-gray-200 bg-white/85 px-4 py-3 text-gray-900 shadow-inner focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30" />
              </div>
              <div class="space-y-2">
                <label for="email" class="block text-gray-800 font-semibold">Email</label>
                <input type="email" id="email" name="email" required autocomplete="email" class="w-full rounded-xl border border-gray-200 bg-white/85 px-4 py-3 text-gray-900 shadow-inner focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30" />
              </div>
              <div class="space-y-2">
                <label for="message" class="block text-gray-800 font-semibold">Message</label>
                <textarea id="message" name="message" rows="5" required class="w-full rounded-xl border border-gray-200 bg-white/85 px-4 py-3 text-gray-900 shadow-inner focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30"></textarea>
              </div>
              <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <span class="text-sm text-gray-600">I&apos;ll get back to you shortly.</span>
                <button id="submit-button" type="submit" class="inline-flex items-center justify-center gap-2 rounded-xl bg-accent text-white font-semibold px-6 py-3 shadow-lg shadow-accent/25 hover:shadow-accent/35 transition-all duration-200 w-full sm:w-auto">
                  Send Message
                  <Icon name="mdi:send" class="w-5 h-5" />
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </FadeIn>
  </div>
</Layout>

<script is:inline define:vars={{ formspreeFormId, recaptchaSiteKey }}>
  document.addEventListener('astro:page-load', () => {
    const form = document.getElementById('contact-form');
    if (!form) return;

    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    const submitButton = document.getElementById('submit-button');

    const scriptId = 'recaptcha-script';
    const existingScript = document.getElementById(scriptId);
    const badge = document.querySelector('.grecaptcha-badge');

    if (!existingScript || (window.grecaptcha && !badge)) {
      if (existingScript) existingScript.remove();

      const script = document.createElement('script');
      script.id = scriptId;
      script.src = `https://www.google.com/recaptcha/api.js?render=${recaptchaSiteKey}`;
      script.async = true;
      script.defer = true;
      document.body.appendChild(script);
    }

    form.addEventListener('submit', function(e) {
      e.preventDefault();

      if (!window.grecaptcha) {
        console.error("reCAPTCHA not loaded");
        errorMessage.classList.remove('hidden');
        return;
      }

      grecaptcha.ready(function() {
        grecaptcha.execute(recaptchaSiteKey, { action: 'submit' }).then(async function(token) {
          const formData = new FormData(form);
          formData.append('g-recaptcha-response', token);

          submitButton.disabled = true;
          submitButton.textContent = 'Sending...';

          try {
            const response = await fetch(`https://formspree.io/f/${formspreeFormId}`, {
              method: 'POST',
              body: formData,
              headers: { 'Accept': 'application/json' }
            });

            if (response.ok) {
              form.reset();
              successMessage.classList.remove('hidden');
              errorMessage.classList.add('hidden');
              setTimeout(() => successMessage.classList.add('hidden'), 5000);
            } else {
              errorMessage.classList.remove('hidden');
              successMessage.classList.add('hidden');
            }
          } catch (error) {
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
          } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Send Message';
          }
        });
      });
    });
  });
</script>
