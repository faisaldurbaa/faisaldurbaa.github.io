---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import FadeIn from '../../components/FadeIn.astro';
import Card from '../../components/Card.astro';

const blogEntries = await getCollection('blog');
const fallbackDate = new Date('1970-01-01');

const sortedContent = blogEntries.sort((a, b) =>
  (b.data.publishDate ? new Date(b.data.publishDate) : fallbackDate).valueOf() -
  (a.data.publishDate ? new Date(a.data.publishDate) : fallbackDate).valueOf()
);

const uniqueTags = Array.from(
  new Set(
    sortedContent.flatMap((entry) => entry.data.tags || [])
  )
).sort((a, b) => a.localeCompare(b));

const seo = {
  title: "Blogs",
  description: "Explore my latest blog posts on AI, software, and technical strategy.",
};
---
<Layout seo={seo}>
  <div class="container mx-auto px-4 py-16 max-w-6xl">
    <FadeIn>
      <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between mb-10">
        <div>
          <p class="text-sm font-semibold text-accent uppercase tracking-wide">Blogs</p>
          <h1 class="text-4xl font-bold text-gray-900">All Articles</h1>
          <p class="text-gray-600 mt-2">Deep dives, notes, and experiments from my work.</p>
        </div>
        <div class="flex flex-col gap-3 w-full md:w-[360px]">
          <input
            type="text"
            id="blog-search-input"
            placeholder="Search by title or description..."
            class="w-full rounded-xl border border-gray-200 bg-white/80 backdrop-blur px-4 py-3 shadow-sm focus:outline-none focus:ring-2 focus:ring-accent/40 focus:border-accent/60"
          />
          {uniqueTags.length > 0 && (
            <div class="flex flex-wrap gap-2" id="blog-tags">
              <button data-tag="all" class="tag-pill active">All</button>
              {uniqueTags.map((tag) => (
                <button data-tag={tag} class="tag-pill">{tag}</button>
              ))}
            </div>
          )}
        </div>
      </div>
    </FadeIn>

    <div id="blog-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 items-stretch">
      {sortedContent.map((item) => (
        <FadeIn>
          <div
            class="blog-item h-full"
            data-title={`${item.data.title} ${item.data.description}`.toLowerCase()}
            data-tags={(item.data.tags || []).map(tag => tag.toLowerCase()).join(',')}
          >
            <Card
              title={item.data.title}
              description={item.data.description}
              href={`/blog/${item.slug}/`}
              tags={item.data.tags ?? []}
              type="blog"
              publishDate={item.data.publishDate}
              heroImage={item.data.heroImage}
            />
          </div>
        </FadeIn>
      ))}
    </div>
  </div>
</Layout>

<style>
  .tag-pill {
    display: inline-flex;
    align-items: center;
    border-radius: 9999px;
    border: 1px solid rgb(229 231 235);
    background: rgba(255, 255, 255, 0.7);
    color: rgb(55 65 81);
    font-size: 0.875rem;
    font-weight: 500;
    padding: 0.375rem 0.75rem;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    transition: all 150ms ease;
  }
  .tag-pill:hover {
    border-color: rgba(30, 41, 59, 0.5);
    color: rgb(30, 41, 59);
  }
  .tag-pill.active {
    background: rgb(30, 41, 59);
    color: #fff;
    border-color: rgb(30, 41, 59);
    box-shadow: 0 10px 20px rgba(30, 41, 59, 0.15);
  }
</style>

<script is:inline>
  const searchInput = document.getElementById('blog-search-input');
  const tagButtons = document.querySelectorAll('#blog-tags .tag-pill');
  const blogItems = document.querySelectorAll('.blog-item');

  function applyFilters() {
    const searchTerm = (searchInput?.value || '').toLowerCase();
    const activeTag = document.querySelector('#blog-tags .tag-pill.active')?.getAttribute('data-tag') || 'all';

    blogItems.forEach((item) => {
      const text = item.getAttribute('data-title') || '';
      const tags = (item.getAttribute('data-tags') || '').split(',');

      const matchesSearch = text.includes(searchTerm);
      const matchesTag = activeTag === 'all' || tags.includes(activeTag.toLowerCase());

      item.classList.toggle('hidden', !(matchesSearch && matchesTag));
    });
  }

  searchInput?.addEventListener('input', applyFilters);
  tagButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      tagButtons.forEach((b) => b.classList.remove('active'));
      btn.classList.add('active');
      applyFilters();
    });
  });
</script>
