---
import { getCollection, type CollectionEntry } from 'astro:content';
import Card from './Card.astro';

interface Props {
  currentSlug: string;
}

const { currentSlug } = Astro.props;

const blogEntries = await getCollection('blog');
const projectEntries = await getCollection('projects');
const courseEntries = (await getCollection('courses')).filter(
  (course: CollectionEntry<'courses'>) => course.id.endsWith('index.mdx') || course.id.endsWith('index.md')
);

const allContent = [
  ...blogEntries.map((entry: CollectionEntry<'blog'>) => ({
    type: 'blog' as const,
    title: entry.data.title,
    description: entry.data.description,
    href: `/blog/${entry.slug}/`,
    tags: entry.data.tags || [],
    publishDate: entry.data.publishDate,
    heroImage: entry.data.heroImage,
    slug: entry.slug,
  })),
  ...projectEntries.map((entry: CollectionEntry<'projects'>) => ({
    type: 'project' as const,
    title: entry.data.title,
    description: entry.data.description,
    href: `/projects/${entry.slug}/`,
    tags: entry.data.tags || [],
    publishDate: entry.data.publishDate,
    heroImage: entry.data.heroImage,
    slug: entry.slug,
  })),
  ...courseEntries.map((entry: CollectionEntry<'courses'>) => ({
    type: 'course' as const,
    title: entry.data.title,
    description: entry.data.description,
    href: `/courses/${entry.slug.replace(/\/index$/, '')}/`,
    tags: entry.data.tags || [],
    publishDate: entry.data.publishDate,
    heroImage: entry.data.heroImage,
    slug: entry.slug.replace(/\/index$/, ''),
  })),
];

const fallbackDate = new Date('1970-01-01');
const relatedContent = allContent
  .filter(item => item.slug !== currentSlug)
  .sort((a, b) => 
    (b.publishDate ? new Date(b.publishDate) : fallbackDate).valueOf() - 
    (a.publishDate ? new Date(a.publishDate) : fallbackDate).valueOf()
  )
  .slice(0, 6);
---

{relatedContent.length > 0 && (
  <section class="py-20 px-4">
    <div class="container mx-auto max-w-6xl">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between px-2 sm:px-0">
        <div>
          <p class="text-xs uppercase tracking-[0.2em] text-gray-500">Keep reading</p>
          <h3 class="text-3xl font-bold text-gray-900">Continue exploring</h3>
          <p class="text-gray-600 mt-1">Fresh picks from blog, projects, and courses.</p>
        </div>
        <div class="flex items-center gap-3 text-sm text-gray-600">
          <button id="related-left" class="h-10 w-10 rounded-full border border-gray-200 bg-white shadow-sm hover:border-accent hover:text-accent transition-colors flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
          </button>
          <button id="related-right" class="h-10 w-10 rounded-full border border-gray-200 bg-white shadow-sm hover:border-accent hover:text-accent transition-colors flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
          </button>
        </div>
      </div>

      <div class="relative mt-4">
        <div
          id="related-scroll"
          class="flex gap-4 overflow-x-auto pb-3 scrollbar-hide snap-x snap-mandatory px-1 sm:px-0"
          style="scrollbar-width: none; -ms-overflow-style: none;"
        >
          {relatedContent.map(item => (
            <div class="snap-start min-w-[75%] sm:min-w-[310px] md:min-w-[340px] lg:min-w-[368px]">
              <Card
                title={item.title}
                description={item.description}
                href={item.href}
                tags={item.tags}
                type={item.type}
                publishDate={item.publishDate}
                heroImage={item.heroImage}
              />
            </div>
          ))}
        </div>
      </div>
    </div>
  </section>
)}

<style>
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  
  .scrollbar-hide {
    scrollbar-width: none;
  }
</style>

<script>
  if (typeof window !== 'undefined') {
    const setup = () => {
      const scrollEl = document.getElementById('related-scroll');
      const leftBtn = document.getElementById('related-left');
      const rightBtn = document.getElementById('related-right');
      if (!scrollEl || !leftBtn || !rightBtn) return;

      const scrollAmount = 360;
      leftBtn.addEventListener('click', () => scrollEl.scrollBy({ left: -scrollAmount, behavior: 'smooth' }));
      rightBtn.addEventListener('click', () => scrollEl.scrollBy({ left: scrollAmount, behavior: 'smooth' }));
    };

    setup();
    document.addEventListener('astro:after-swap', setup);
  }
</script>
