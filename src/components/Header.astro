---
const navLinks = [
  { name: "Home", href: "/" },
  { name: "Projects", href: "/projects/" },
  { name: "Blog", href: "/blog/" },
  { name: "About", href: "/about/" },
  { name: "Contact", href: "/contact/" },
];

// Astro global is provided in .astro frontmatter; cast to avoid TS namespace error
const currentPath: string = (Astro as unknown as { url: URL }).url.pathname.replace(/\/$/, "");

const isActiveLink = (linkHref: string) => {
  const normalizedLink = linkHref.replace(/\/$/, "");

  if (linkHref === "/projects/") {
    return (
      currentPath === normalizedLink ||
      currentPath.startsWith("/projects/") ||
      currentPath.startsWith("/courses/")
    );
  }

  if (linkHref === "/blog/") {
    return currentPath === normalizedLink || currentPath.startsWith("/blog/");
  }

  return currentPath === normalizedLink;
};
---
<header class="fixed top-0 left-0 right-0 z-50 flex flex-col items-center pointer-events-none" data-astro-transition-persist>
  <div
    id="nav-shell"
    class="pointer-events-auto relative z-50 flex items-center justify-between transition-all duration-700 ease-[cubic-bezier(0.4,0,0.2,1)]
           w-full max-w-full rounded-none border-b border-gray-200/50 bg-white/70 backdrop-blur-2xl shadow-sm py-3 px-4 md:px-8 mt-0
    data-[scrolled=true]:w-[90%] data-[scrolled=true]:md:w-[75%] data-[scrolled=true]:max-w-7xl data-[scrolled=true]:rounded-3xl data-[scrolled=true]:border data-[scrolled=true]:border-white/40 data-[scrolled=true]:shadow-xl data-[scrolled=true]:mt-6 data-[scrolled=true]:py-2.5"
    data-scrolled="false"
  >
    <a href="/" class="text-lg md:text-xl font-bold text-gray-900 hover:text-accent transition-colors flex items-center gap-2">
       Faisal Durbaa
    </a>
    
    <nav class="hidden md:flex items-center gap-1 relative p-1"> 
      <!-- Sliding Pill -->
      <div 
        id="nav-pill" 
        class="absolute top-1/2 left-0 h-[85%] -translate-y-1/2 bg-accent rounded-full transition-all duration-300 ease-[cubic-bezier(0.4,0,0.2,1)] -z-0 shadow-md opacity-0 pointer-events-none"
      ></div>

      {navLinks.map(link => (
        <a
          href={link.href}
          data-active={isActiveLink(link.href)}
          class:list={[
            "relative z-10 py-2 px-4 rounded-full text-sm font-medium transition-colors duration-300",
            isActiveLink(link.href)
              ? 'text-accent bg-gray-900/5'
              : 'text-gray-600 hover:text-accent'
          ]}
        >
          {link.name}
        </a>
      ))}
    </nav>

    <div class="md:hidden">
      <button id="mobile-menu-button" aria-controls="mobile-menu" aria-expanded="false" class="p-2 rounded-full text-gray-700 hover:bg-gray-100/50 hover:text-accent focus:outline-none focus:ring-2 focus:ring-inset focus:ring-accent transition-colors">
        <span class="sr-only">Open main menu</span>
        <svg id="hamburger-icon" class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
        <svg id="close-icon" class="h-6 w-6 hidden" stroke="currentColor" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <div id="mobile-menu" class="pointer-events-auto hidden md:hidden w-[92%] mt-2 z-40">
    <div class="bg-white/70 backdrop-blur-2xl border border-white/40 shadow-xl rounded-2xl p-2 transform origin-top animate-in fade-in slide-in-from-top-2 duration-300">
      <nav class="flex flex-col gap-1">
        {navLinks.map(link => (
          <a
            href={link.href}
            class:list={[
              "block py-3 px-4 rounded-xl text-base font-medium transition-all duration-200",
              isActiveLink(link.href)
                ? 'bg-accent text-white font-semibold pl-6 shadow-md'
                : 'text-gray-600 hover:bg-gray-100/50 hover:text-accent hover:pl-5'
            ]}
            aria-current={isActiveLink(link.href) ? 'page' : undefined}
          >
            {link.name}
          </a>
        ))}
      </nav>
    </div>
  </div>
</header>

<script>
  // Set initial state immediately to avoid first-paint flicker
  {
    const navShell = document.getElementById('nav-shell');
    if (navShell) {
      const shouldFloat = sessionStorage.getItem('nav-was-floating') === 'true' || window.scrollY > 20;
      const previous = navShell.style.transition;
      navShell.style.transition = 'none';
      navShell.dataset.scrolled = shouldFloat ? 'true' : 'false';
      void navShell.offsetWidth;
      navShell.style.transition = previous;
    }
  }

  function init() {
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const hamburgerIcon = document.getElementById('hamburger-icon');
    const closeIcon = document.getElementById('close-icon');
    const navShell = document.getElementById('nav-shell');
    if (!navShell) return;
    const isBound = navShell.dataset.bound === 'true';
    if (!isBound) navShell.dataset.bound = 'true';
    
    // Sliding Pill Logic
    const desktopNav = document.querySelector('nav.hidden.md\\:flex');
    const pill = document.getElementById('nav-pill');
    const desktopLinks = desktopNav?.querySelectorAll<HTMLAnchorElement>('a') ?? [];
    const mobileLinks = mobileMenu?.querySelectorAll<HTMLAnchorElement>('a') ?? [];

    const computeActive = (href: string) => {
      const currentPath = window.location.pathname.replace(/\/$/, '');
      const normalizedLink = href.replace(/\/$/, '');
      if (href === '/projects/') {
        return (
          currentPath === normalizedLink ||
          currentPath.startsWith('/projects') ||
          currentPath.startsWith('/courses')
        );
      }
      if (href === '/blog/') {
        return currentPath === normalizedLink || currentPath.startsWith('/blog');
      }
      return currentPath === normalizedLink;
    };

    const updateActiveLinks = () => {
      const desktopActiveClasses = ['text-accent', 'bg-gray-900/5'];
      const desktopInactiveClasses = ['text-gray-600', 'hover:text-accent'];
      const mobileActiveClasses = ['bg-accent', 'text-white', 'font-semibold', 'pl-6', 'shadow-md'];
      const mobileInactiveClasses = ['text-gray-600', 'hover:bg-gray-100/50', 'hover:text-accent', 'hover:pl-5'];

      desktopLinks.forEach((link) => {
        const href = link.getAttribute('href') || '';
        const active = computeActive(href);
        link.dataset.active = active ? 'true' : 'false';
        link.classList.remove(
          'text-white',
          ...desktopActiveClasses,
          ...desktopInactiveClasses
        );
        if (active) {
          link.classList.add(...desktopActiveClasses);
          link.setAttribute('aria-current', 'page');
        } else {
          link.classList.add(...desktopInactiveClasses);
          link.removeAttribute('aria-current');
        }
      });

      mobileLinks.forEach((link) => {
        const href = link.getAttribute('href') || '';
        const active = computeActive(href);
        link.dataset.active = active ? 'true' : 'false';
        link.classList.remove(
          ...mobileActiveClasses,
          ...mobileInactiveClasses
        );
        if (active) {
          link.classList.add(...mobileActiveClasses);
          link.setAttribute('aria-current', 'page');
        } else {
          link.classList.add(...mobileInactiveClasses);
          link.removeAttribute('aria-current');
        }
      });
    };

    function updatePill(target: HTMLElement | null) {
      if (!desktopNav || !pill || !target) return;

      const navRect = desktopNav.getBoundingClientRect();
      const targetRect = target.getBoundingClientRect();
      
      const width = targetRect.width;
      // Calculate center-to-center difference or just left offset
      // Since pill is top-1/2 left-0, we just need translateX
      const left = targetRect.left - navRect.left;

      pill.style.width = `${width}px`;
      pill.style.transform = `translateX(${left}px) translateY(-50%)`; // translateY to maintain vertical center
      pill.style.opacity = '1';

      // Update text colors for contrast
      desktopLinks.forEach(link => {
        if (link === target) {
          link.classList.remove('text-gray-600', 'hover:text-accent', 'text-accent');
          link.classList.add('text-white');
        } else {
          link.classList.add('text-gray-600', 'hover:text-accent');
          link.classList.remove('text-white', 'text-accent');
        }
      });
    }

    const positionPill = (immediate = false) => {
      if (!desktopNav || !pill || desktopLinks.length === 0) return;
      const activeLink = desktopNav.querySelector('[data-active="true"]') as HTMLElement | null;
      if (!activeLink) {
        pill.style.opacity = '0';
        return;
      }
      const previous = pill.style.transition;
      if (immediate) pill.style.transition = 'none';
      requestAnimationFrame(() => {
        updatePill(activeLink);
        void pill.offsetWidth;
        if (immediate) pill.style.transition = previous;
      });
    };

    function setMenuState(open: boolean) {
      if (!mobileMenuButton || !mobileMenu || !hamburgerIcon || !closeIcon) return;
      mobileMenuButton.setAttribute('aria-expanded', open ? 'true' : 'false');
      mobileMenu.classList.toggle('hidden', !open);
      hamburgerIcon.classList.toggle('hidden', open);
      closeIcon.classList.toggle('hidden', !open);
    }

    function toggleMenu() {
      if (!mobileMenuButton || !mobileMenu || !hamburgerIcon || !closeIcon) return;
      const isExpanded = mobileMenuButton.getAttribute('aria-expanded') === 'true';
      setMenuState(!isExpanded);
    }

    function updateNavState(immediate = false) {
      if (!navShell) return;
      const scrollY = window.scrollY;
      const floating = scrollY > 20;

      const previous = navShell.style.transition;
      if (immediate) navShell.style.transition = 'none';

      if (floating && navShell.dataset.scrolled !== 'true') {
        navShell.dataset.scrolled = 'true';
      } else if (!floating && navShell.dataset.scrolled !== 'false') {
        navShell.dataset.scrolled = 'false';
      }

      if (immediate) {
        requestAnimationFrame(() => {
          navShell.style.transition = previous;
        });
      }
    }

    function handleStickBack() {
      if (!navShell) return;
      const wasFloating = sessionStorage.getItem('nav-was-floating') === 'true';

      if (wasFloating && window.scrollY <= 20) {
        const previous = navShell.style.transition;
        navShell.style.transition = 'none';
        navShell.dataset.scrolled = 'true';
        void navShell.offsetWidth;
        navShell.style.transition = previous;

        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            navShell.dataset.scrolled = 'false';
            sessionStorage.removeItem('nav-was-floating');
          });
        });
      } else {
        updateNavState(true);
      }
    }

    function setupNavClickListeners() {
      if (!navShell) return;
      document.addEventListener('click', (event) => {
        const target = event.target as HTMLElement | null;
        const link = target?.closest('a[href]') as HTMLAnchorElement | null;
        if (!link) return;
        const href = link.getAttribute('href') || '';
        if (!href.startsWith('/')) return;
        if (navShell.dataset.scrolled === 'true') {
          sessionStorage.setItem('nav-was-floating', 'true');
        }
      });
    }

    // Event Listeners
    if (!isBound) {
      if (mobileMenuButton) {
        mobileMenuButton.addEventListener('click', toggleMenu);
      }

      if (mobileMenu) {
        mobileMenu.addEventListener('click', (e) => {
          const target = e.target as HTMLElement | null;
          const link = target?.closest('a');
          if (link) {
            setMenuState(false);
          }
        });
      }
    }

    // Scroll handling with cleanup
    let ticking = false;
    const onScroll = () => {
        if (!ticking) {
            window.requestAnimationFrame(() => {
                updateNavState();
                ticking = false;
            });
            ticking = true;
        }
    };
    
    if (!isBound) {
      window.addEventListener('scroll', onScroll, { passive: true });
      setupNavClickListeners();

      if (desktopNav && pill && desktopLinks.length > 0) {
        desktopLinks.forEach(link => {
          link.addEventListener('mouseenter', () => updatePill(link));
        });

        desktopNav.addEventListener('mouseleave', () => {
          const active = desktopNav.querySelector('[data-active="true"]') as HTMLElement | null;
          if (active) updatePill(active);
          else pill.style.opacity = '0';
        });
      }
    }

    // Initial run / refresh
    updateActiveLinks();
    positionPill(true);
    setMenuState(false);
    handleStickBack();
  }

  // Run on initial load and after every navigation
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, { once: true });
  } else {
    init();
  }
  document.addEventListener('astro:after-swap', () => {
    init();
  });
</script>
